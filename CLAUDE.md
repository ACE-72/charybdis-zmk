# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

ZMK firmware configuration for a Charybdis Nano split keyboard (wireless, using nice!nano v2 controllers). This is a user config repo—not the ZMK firmware itself. Firmware is built via GitHub Actions using the ZMK build system.

## Build System

Firmware is built entirely through GitHub Actions (`.github/workflows/build.yml`). There is no local build. Pushing to the repo triggers `zmkfirmware/zmk/.github/workflows/build-user-config.yml` which compiles firmware for both halves (`charybdis_left`, `charybdis_right`) and a `settings_reset` image, all targeting `nice_nano_v2`.

The keymap diagram (`keymap-drawer/charybdis.svg`) is auto-generated by the `draw-keymaps.yml` workflow using [keymap-drawer](https://github.com/caksoylar/keymap-drawer) whenever `config/*.keymap`, `config/*.dtsi`, or `keymap_drawer.config.yaml` changes.

## Key Files

- `config/charybdis.keymap` — Main keymap definition (layers, behaviors, key bindings)
- `config/combos.dtsi` — Combo definitions (included by the keymap via `#include "combos.dtsi"`)
- `config/west.yml` — West manifest pointing to a custom ZMK fork (`petejohanson/zmk`, `feat/pointers-move-scroll` branch) and the PMW3610 trackball driver
- `boards/shields/charybdis/` — Shield definition (overlay files, Kconfig, device tree)
- `build.yaml` — Defines the build matrix (board/shield combinations)
- `keymap_drawer.config.yaml` — Keymap-drawer rendering config (styling, glyph mappings)

## Keymap Architecture

8 layers: BASE (0), NUFU (1), SYM (2), NAV (3), MED (4), POI (5), SCR (6), SNI (7).

Uses homerow mods (`hml`/`hmr` behaviors) with bilateral key position filtering—left-hand mods only trigger from right-hand keys and vice versa. The hold-trigger-key-positions arrays encode this.

The `default_transform` matrix transform is used (35-key layout: 5 columns × 3 rows + 2/3 thumbs). Key positions 0-4 are top-left, 5-9 top-right, etc. Thumb keys are 30-34.

## Combo Macro

Combos use a `COMBO(NAME, BINDINGS, KEYPOS, LAYERS, MS)` macro in `combos.dtsi`. All combos have `require-prior-idle-ms = <150>`.

## GPIO Pin Mapping (CRITICAL)

This board uses **raw nRF GPIO pins**, NOT `&pro_micro` aliases. The `&pro_micro` pin numbers map to completely different physical GPIOs and will not work. The working pinout (from the factory firmware at `Vzhao-L/zmk-for-charybdis`, `charybdis-Nano35` branch):

- **Row GPIOs**: `gpio0 31`, `gpio1 15`, `gpio0 24`, `gpio0 22`
- **Col GPIOs**: `gpio0 2`, `gpio0 29`, `gpio0 9`, `gpio1 0`, `gpio0 11`
- **Matrix**: 10 columns × 4 rows, `col-offset = <5>` on right side
- **Diode direction**: `row2col`
- **Trackball SPI** (right side only): SCK=`gpio0 8`, MOSI/MISO=`gpio0 17`, CS=`gpio0 20`, IRQ=`gpio0 6`

## Dependencies

Uses a forked ZMK (`petejohanson/zmk` on `feat/pointers-move-scroll`) for trackball/pointer support, plus `inorichi/zmk-pmw3610-driver` for the PMW3610 trackball sensor.
